default:
  image: rust:latest
  cache: # Cache the following directories
    key: $CI_COMMIT_REF_SLUG
    paths:
      - .cargo/bin
      - .cargo/registry/index
      - .cargo/registry/cache
      - target/debug/deps
  before_script:
    - rustup self update
    - rustup update
    - rustc --version                               # Print version of Rust compiler
    - rustup component add rustfmt
    - rustup component add clippy

stages:
  - source
  - build
  - test
  - deploy

format-job:
  stage: source
  script:
    - cargo fmt

fix-job:
  stage: source
  script:
    - cargo fix

lint-job:
  stage: source
  script:
    - cargo clippy -- -Dwarnings

update-dependencies-job:
  stage: build
  script:
    - cargo update

build-job:
  stage: build
  script:
    - cargo install cargo-hack
    - cargo hack check --feature-powerset --mutually-exclusive-features no_std,uuid --lib --tests

test-job:
  stage: test
  allow_failure: false
  script:
    - cargo install cargo-hack
    - cargo hack test --feature-powerset --mutually-exclusive-features no_std,uuid

deploy:
  stage: deploy
  needs:
    - test-job
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - when: never
  script:
    - cargo publish --token $CARGO_REGISTRY_TOKEN
  release:
    name: $CI_COMMIT_TAG
    tag_name: $CI_COMMIT_TAG
    description: $CI_COMMIT_TAG_MESSAGE
